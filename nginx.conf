# Nginx Configuration for Modern Media Thumbnails
# 
# This configuration enables content negotiation to serve optimized image formats
# based on browser capabilities. The plugin generates AVIF and WebP versions of
# thumbnails, and this configuration intelligently serves the best format.
#
# Place this configuration in your nginx server block.
# 
# How it works:
# 1. Checks if browser supports AVIF via Accept header
# 2. Checks if browser supports WebP via Accept header
# 3. Serves images in priority: AVIF → WebP → Original (JPEG/PNG/GIF)
# 4. Sets appropriate cache headers for 1 year expiration

# Content negotiation for modern image formats
# Check if browser supports AVIF
set $ext_avif "";
if ($http_accept ~* "image/avif") {
	set $ext_avif ".avif";
}

# Check if browser supports WebP
set $ext_webp "";
if ($http_accept ~* "image/webp") {
	set $ext_webp ".webp";
}

# Serve optimized images based on browser capabilities
# Matches: image.jpg, image.jpeg, image.png, image.gif, image.webp
location ~ ^/wp-content/(?<path>.+)\.(?<ext>jpe?g|png|gif|webp)$ {
	add_header Vary "Accept" always;
	add_header Cache-Control "private, max-age=31536000, immutable" always;
	expires 365d;

	# Try AVIF first (if browser supports it)
	# Then try WebP (if browser supports it)
	# Then serve original file
	# Finally return 404 if none exist
	try_files 
		/wp-content/$path.$ext$ext_avif
		/wp-content/$path.$ext$ext_webp
		$uri
		=404;
}
